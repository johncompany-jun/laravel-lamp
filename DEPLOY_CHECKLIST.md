# デプロイチェックリスト

エックスサーバーへのデプロイ時に確認すべき項目のチェックリストです。

## デプロイ前の準備

### ローカル環境での確認

- [ ] すべてのテストが通る（`php artisan test`）
- [ ] フロントエンドアセットをビルド（`npm run build`）
- [ ] `public/build/` ディレクトリが生成されていることを確認
- [ ] コードがGitリポジトリにプッシュされている
- [ ] 本番用の`.env.production`ファイルを準備
- [ ] データベース接続情報を確認
- [ ] メール設定情報を確認
- [ ] アプリケーションURLを確認

### エックスサーバー側の準備

- [ ] MySQLデータベースを作成済み
  - データベース名: __________________
  - ユーザー名: __________________
  - パスワード: __________________
  - ホスト: mysqlXXX.xserver.jp
- [ ] SSH接続を有効化済み
- [ ] PHPバージョンを8.3に設定済み
- [ ] SSL証明書を設定済み（Let's Encrypt等）
- [ ] メールアカウントを作成済み（メール送信用）

## デプロイ作業

### 1. ファイルのアップロード

- [ ] SSH接続成功
- [ ] アプリケーションファイルをアップロード完了
  - 方法: [ ] Git  [ ] SFTP/SCP
- [ ] ディレクトリ構成を確認
  ```
  /home/your-account/
  ├── your-domain.com/
  │   └── public_html/ → シンボリックリンク
  └── laravel-app/
  ```

### 2. 依存関係のインストール

- [ ] Composerをダウンロード
- [ ] `php composer.phar install --no-dev --optimize-autoloader` 実行完了

### 3. 環境設定

- [ ] `.env`ファイルを作成・配置
- [ ] `APP_KEY`を生成（`php artisan key:generate`）
- [ ] `.env`の内容を確認
  - [ ] `APP_ENV=production`
  - [ ] `APP_DEBUG=false`
  - [ ] `APP_URL` が正しい
  - [ ] `DB_*` 設定が正しい
  - [ ] `MAIL_*` 設定が正しい

### 4. パーミッション設定

- [ ] `chmod -R 775 storage` 実行
- [ ] `chmod -R 775 bootstrap/cache` 実行

### 5. データベースのセットアップ

- [ ] `php artisan migrate --force` 実行完了
- [ ] `php artisan db:seed --force` 実行完了（必要な場合）
- [ ] データベースの内容を確認

### 6. 公開ディレクトリの設定

- [ ] `public_html`のシンボリックリンクを作成
- [ ] `php artisan storage:link` 実行
- [ ] `.htaccess`ファイルを確認・配置
  - オプション: `.htaccess.xserver`を使用する場合

### 7. 最適化

- [ ] `php artisan config:cache` 実行
- [ ] `php artisan route:cache` 実行
- [ ] `php artisan view:cache` 実行

## デプロイ後の動作確認

### 基本動作

- [ ] トップページにアクセスできる（https://your-domain.com）
- [ ] HTTPSで接続できる
- [ ] CSS/JavaScriptが正しく読み込まれている
- [ ] ファビコンが表示される

### 認証機能

- [ ] 新規登録ができる
- [ ] ログインができる
- [ ] ログアウトができる
- [ ] パスワードリセットができる（メール送信確認）

### ユーザー機能

- [ ] ダッシュボードが表示される
- [ ] イベント一覧が表示される
- [ ] イベント詳細が表示される
- [ ] イベント申込ができる
- [ ] 申込履歴が表示される
- [ ] 確定スケジュールが表示される（ステータスが「確定」のもの）
- [ ] 申込のキャンセルができる

### 管理者機能

- [ ] 管理画面にアクセスできる
- [ ] イベント一覧が表示される
- [ ] イベントを作成できる
- [ ] イベントを編集できる
- [ ] イベントを削除できる
- [ ] イベント詳細が表示される
- [ ] アサイン画面が表示される
- [ ] アサインを作成できる
- [ ] ステータスを変更できる
  - [ ] 下書き → 募集中
  - [ ] 募集中 → 確定
  - [ ] 募集中 → 中止

### データベース

- [ ] イベントデータが正しく保存される
- [ ] 申込データが正しく保存される
- [ ] アサインデータが正しく保存される
- [ ] ユーザーデータが正しく保存される

### エラーハンドリング

- [ ] 存在しないページで404エラーが表示される
- [ ] 権限のないページで403エラーが表示される
- [ ] エラーログが`storage/logs/laravel.log`に記録される

## セキュリティチェック

- [ ] `.env`ファイルが外部からアクセスできない
- [ ] `storage/`ディレクトリが外部からアクセスできない
- [ ] `APP_DEBUG=false`になっている
- [ ] 管理画面に適切なアクセス制限がある
- [ ] CSRF保護が有効
- [ ] パスワードが適切にハッシュ化されている

## パフォーマンスチェック

- [ ] ページの読み込み時間が3秒以内
- [ ] データベースクエリが最適化されている
- [ ] N+1問題が発生していない
- [ ] OPcacheが有効になっている
- [ ] キャッシュが正しく動作している

## バックアップ設定

- [ ] データベースバックアップ方法を確認
- [ ] ファイルバックアップ方法を確認
- [ ] 定期バックアップのスケジュール設定（推奨）

## メール通知（将来実装予定）

現在はコメントアウトされています。有効化する場合：

- [ ] `UpdateEventUseCase.php`のコメントを解除
- [ ] メール設定を確認
- [ ] テストメールを送信
- [ ] 確定メールが送信される（ステータス変更時）
- [ ] 中止メールが送信される（ステータス変更時）

## トラブルシューティング

問題が発生した場合の対処：

### 500 Internal Server Error
```bash
chmod -R 775 storage
chmod -R 775 bootstrap/cache
php artisan config:clear
tail -f storage/logs/laravel.log
```

### CSS/JSが読み込まれない
- `.env`の`APP_URL`を確認
- `public`フォルダのシンボリックリンクを確認
- ブラウザのキャッシュをクリア

### データベース接続エラー
- `.env`のDB_*設定を再確認
- MySQLホスト名を確認
- データベースとユーザーが作成されているか確認

### メール送信エラー
- エックスサーバーのメールアカウントを確認
- `.env`のMAIL_*設定を確認
- MAIL_ENCRYPTION=ssl、MAIL_PORT=465を使用

## 完了確認

すべてのチェックが完了したら：

- [ ] 本番環境で正常に動作することを確認
- [ ] ユーザーにアクセス情報を共有
- [ ] 監視・メンテナンス体制を確立
- [ ] このチェックリストを保存（次回デプロイ時に参照）

---

**デプロイ日**: ____________________

**デプロイ担当者**: ____________________

**確認者**: ____________________

**備考**:
